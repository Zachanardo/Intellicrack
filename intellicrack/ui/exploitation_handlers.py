"""Exploitation handlers for Intellicrack UI.

This file is part of Intellicrack.
Copyright (C) 2025 Zachary Flint.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see https://www.gnu.org/licenses/.
"""

import logging

from intellicrack.handlers.pyqt6_handler import QMessageBox


"""
Exploitation UI Handler Methods

This module contains all the handler methods for the enhanced exploitation UI
components in Intellicrack. These methods integrate with the core exploitation
frameworks implemented in the previous phases.
"""

logger = logging.getLogger(__name__)

try:
    from ..utils.exploitation.payload_result_handler import PayloadResultHandler
except ImportError as e:
    logger.error("Import error in exploitation_handlers: %s", e)
    PayloadResultHandler = None


def cleanup_exploitation(self: object) -> None:
    """Clean up exploitation resources and reset state."""
    try:
        self.exploit_output.append("=== Cleaning Up Exploitation Resources ===")

        if hasattr(self, "current_payload"):
            delattr(self, "current_payload")
            self.exploit_output.append("OK Cleared payload data")

        if hasattr(self, "current_payload_metadata"):
            delattr(self, "current_payload_metadata")
            self.exploit_output.append("OK Cleared payload metadata")

        if hasattr(self, "payload_engine"):
            self.exploit_output.append("OK Reset payload engine")

        self.exploit_output.append("Cleanup completed successfully")

    except Exception as e:
        logger.error(f"Exploitation cleanup failed: {e}")
        self.exploit_output.append(f"FAIL Cleanup error: {e}")


def save_exploitation_output(self: object) -> None:
    """Save exploitation output and results to file."""
    try:
        from datetime import datetime

        from ..handlers.pyqt6_handler import QFileDialog

        default_name = f"exploitation_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"

        file_path, _ = QFileDialog.getSaveFileName(self, "Save Exploitation Output", default_name, "Text Files (*.txt);;All Files (*.*)")

        if file_path:
            output_text = self.exploit_output.toPlainText()

            with open(file_path, "w", encoding="utf-8") as f:
                f.write("=== Intellicrack Exploitation Report ===\n")
                f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"Target Binary: {getattr(self, 'binary_path', 'Not specified')}\n")
                f.write("\n" + "=" * 50 + "\n\n")
                f.write(output_text)

            self.exploit_output.append(f"\nOK Output saved to: {file_path}")
            QMessageBox.information(self, "Saved", f"Exploitation output saved to:\n{file_path}")

    except Exception as e:
        logger.error(f"Failed to save exploitation output: {e}")
        self.exploit_output.append(f"FAIL Save error: {e}")
        QMessageBox.critical(self, "Error", f"Failed to save output:\n{e}")
