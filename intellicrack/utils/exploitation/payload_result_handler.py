"""This file is part of Intellicrack.
Copyright (C) 2025 Zachary Flint

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.

Payload Result Handler

Common utilities for handling payload generation results.
"""
from collections.abc import Callable
from typing import Any


class PayloadResultHandler:
    """Common handler for payload generation results.
    Eliminates duplicate result processing code.
    """

    @staticmethod
    def process_payload_result(
        result: dict[str, Any],
        output_func: Callable[[str], None],
        save_callback: Callable[[bytes, dict[str, Any]], None] | None = None,
    ) -> bool:
        """Process payload generation result with common pattern.

        Args:
            result: Payload generation result dictionary
            output_func: Function to call for output (e.g., click.echo, append to list)
            save_callback: Optional callback for saving payload data

        Returns:
            True if successful, False otherwise

        """
        if result["success"]:
            payload = result["payload"]
            metadata = result["metadata"]

            output_func("✓ Payload generated successfully!")
            output_func(f"  Size: {metadata['size_bytes']} bytes")
            output_func(f"  Entropy: {metadata['entropy']:.3f}")

            # Handle optional metadata fields
            if "null_bytes" in metadata:
                output_func(f"  Null bytes: {metadata['null_bytes']}")
            if "bad_chars" in metadata:
                output_func(f"  Bad chars: {len(metadata['bad_chars'])}")
            if "compatibility_score" in metadata:
                output_func(f"  Compatibility: {metadata['compatibility_score']:.2f}")
            if "hash_md5" in metadata:
                output_func(f"  MD5: {metadata['hash_md5']}")
            if "generation_time" in result:
                output_func(f"  Generation time: {result['generation_time']:.2f}s")

            # Call save callback if provided
            if save_callback:
                save_callback(payload, metadata)

            return True
        error_msg = result.get("error", "Unknown error occurred")
        output_func(f"✗ Payload generation failed: {error_msg}")
        return False
