#!/usr/bin/env python3
"""
Script to run process hollowing tests with coverage analysis.
"""

import sys
import os
import subprocess
import coverage

def main():
    """Run process hollowing tests with coverage analysis."""

    # Set up paths
    project_root = os.path.dirname(os.path.abspath(__file__))
    test_file = os.path.join(project_root, 'tests', 'unit', 'core', 'anti_analysis', 'test_process_hollowing.py')
    target_module = 'intellicrack.core.anti_analysis.process_hollowing'

    # Initialize coverage
    cov = coverage.Coverage(
        source=[target_module.replace('.', os.sep)],
        omit=['*/test*', '*/tests/*']
    )

    print(f"Running tests for {target_module}")
    print(f"Test file: {test_file}")
    print("-" * 60)

    # Start coverage measurement
    cov.start()

    try:
        # Run pytest programmatically
        import pytest
        result = pytest.main([
            test_file,
            '-v',
            '--tb=short',
            f'--rootdir={project_root}'
        ])

        # Stop coverage measurement
        cov.stop()
        cov.save()

        print("\n" + "=" * 60)
        print("COVERAGE ANALYSIS REPORT")
        print("=" * 60)

        # Generate coverage report
        cov.report(show_missing=True)

        # Generate HTML report
        html_dir = os.path.join(project_root, 'htmlcov', 'process_hollowing')
        cov.html_report(directory=html_dir)
        print(f"\nHTML coverage report generated in: {html_dir}")

        # Check if 80% coverage achieved
        total_coverage = cov.report(file=sys.stdout)
        if total_coverage >= 80:
            print(f"\n✅ SUCCESS: Achieved {total_coverage:.1f}% coverage (≥80% required)")
            return 0
        else:
            print(f"\n❌ INSUFFICIENT: Only {total_coverage:.1f}% coverage (<80% required)")
            return 1

    except Exception as e:
        print(f"Error running tests: {e}")
        return 1

    finally:
        # Cleanup
        if 'cov' in locals():
            cov.stop()

if __name__ == '__main__':
    sys.exit(main())
