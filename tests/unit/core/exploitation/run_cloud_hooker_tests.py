"""Runner script for cloud license hooker tests with coverage."""

import sys
import os

# Add project root to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

try:
    import pytest
    import coverage

    # Start coverage
    cov = coverage.Coverage(source=['intellicrack/core/network/cloud_license_hooker'])
    cov.start()

    # Run tests
    exit_code = pytest.main([
        'tests/unit/core/network/test_cloud_license_hooker.py',
        '-v',
        '--tb=short',
        '-x'  # Stop on first failure
    ])

    # Stop coverage and report
    cov.stop()
    cov.save()

    print("\n" + "="*60)
    print("COVERAGE REPORT")
    print("="*60)
    cov.report()

    # Get coverage percentage
    total = cov.report(show_missing=False)
    print(f"\nTotal Coverage: {total:.1f}%")

    if total >= 80:
        print("✓ Coverage requirement met (80%+)")
    else:
        print(f"✗ Coverage below 80% requirement (current: {total:.1f}%)")

    sys.exit(exit_code)

except ImportError as e:
    print(f"Import error: {e}")
    print("\nAttempting basic import test...")

    try:
        from tests.unit.core.network.test_cloud_license_hooker import (
            TestCloudLicenseResponseGenerator,
            TestCloudLicenseHooker,
            TestProductionReadiness
        )
        print("✓ Test file imports successfully")
        print(f"✓ Found {TestCloudLicenseResponseGenerator.__name__} with {len([m for m in dir(TestCloudLicenseResponseGenerator) if m.startswith('test_')])} test methods")
        print(f"✓ Found {TestCloudLicenseHooker.__name__} with {len([m for m in dir(TestCloudLicenseHooker) if m.startswith('test_')])} test methods")
        print(f"✓ Found {TestProductionReadiness.__name__} with {len([m for m in dir(TestProductionReadiness) if m.startswith('test_')])} test methods")

        # Try to instantiate and run a simple test
        test_instance = TestCloudLicenseResponseGenerator()
        generator = test_instance.generator()
        print(f"✓ Can instantiate generator: {generator.__class__.__name__}")

    except Exception as e2:
        print(f"Failed to import test file: {e2}")
        import traceback
        traceback.print_exc()
