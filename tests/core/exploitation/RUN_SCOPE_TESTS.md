# Quick Reference: Running BypassEngine Scope Validation Tests

## Quick Start

### Run All Scope Validation Tests

```bash
# From project root
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -v
```

### Run with Coverage Report

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -v \
  --cov=intellicrack.core.exploitation.bypass_engine \
  --cov-report=term-missing \
  --cov-report=html
```

### Run Specific Test Categories

```bash
# Test PayloadType enum validation
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation -v

# Test source code scanning
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py::TestBypassEngineSourceCodeValidation -v

# Test payload content validation
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py::TestPayloadContentValidation -v

# Test complete integration
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py::TestCompleteScopeComplianceIntegration -v
```

### Run and Stop on First Failure

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -x -v
```

## Expected Output

### Success (All Tests Pass)

```
test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation::test_payload_type_enum_has_no_shell_payloads PASSED
test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation::test_payload_type_enum_has_no_network_exploitation PASSED
test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation::test_payload_type_enum_has_no_malware_capabilities PASSED
... (115 more tests) ...
test_bypass_engine_scope_validation.py::TestCompleteScopeComplianceIntegration::test_bypass_engine_exports_only_safe_classes PASSED

============================== 118 passed in 2.34s ==============================
```

**Interpretation:** ✓ Scope cleanup is COMPLETE. NO shell-related payloads exist.

### Failure (Scope Violation Detected)

```
test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation::test_payload_type_enum_has_no_shell_payloads FAILED

================================ FAILURES ================================
_______ TestPayloadTypeEnumScopeValidation.test_payload_type_enum_has_no_shell_payloads _______

    def test_payload_type_enum_has_no_shell_payloads(self) -> None:
        """PayloadType enum does NOT contain REVERSE_SHELL or BIND_SHELL."""
        payload_types = [member.name for member in PayloadType]

>       assert "REVERSE_SHELL" not in payload_types
E       AssertionError: assert 'REVERSE_SHELL' not in ['LICENSE_CHECK_BYPASS', 'TRIAL_EXTENSION', ..., 'REVERSE_SHELL']

test_bypass_engine_scope_validation.py:68: AssertionError
```

**Interpretation:** ✗ SCOPE VIOLATION DETECTED. Shell-related payload type found in enum.

**Action Required:** Remove REVERSE_SHELL from PayloadType enum in bypass_engine.py

## Test Categories

### 1. Enum Validation (11 tests)
- Validates PayloadType enum contains ONLY license bypass types
- Fails if shell, network, malware, or exfiltration types exist

### 2. Documentation Validation (9 tests)
- Validates docstrings enforce scope limitations
- Fails if documentation doesn't forbid malware/shells/exploits

### 3. Method Validation (5 tests)
- Validates methods only generate license bypass payloads
- Fails if shell or network payloads are generated

### 4. Source Code Scanning (9 tests)
- Scans source code for prohibited terms and patterns
- Fails if forbidden APIs or terms are found

### 5. Payload Content Analysis (5 tests)
- Analyzes binary payload content for network code
- Fails if socket operations or network APIs detected

### 6. Output Format Validation (3 tests)
- Validates output formats don't enable exploitation
- Fails if download cradles or RCE code found

### 7. Architecture Validation (8 tests)
- Validates all architectures generate license bypass only
- Fails if any architecture generates exploitation code

### 8. Integration Testing (3 tests)
- Validates complete workflows are license-focused
- Fails if any workflow produces exploitation payloads

## Common Failure Scenarios

### Scenario 1: Shell Payload Type Added

```python
# bypass_engine.py - WRONG
class PayloadType(Enum):
    LICENSE_CHECK_BYPASS = "license_check_bypass"
    REVERSE_SHELL = "reverse_shell"  # ← SCOPE VIOLATION
```

**Failed Tests:**
- `test_payload_type_enum_has_no_shell_payloads`
- `test_payload_type_enum_contains_only_license_types`
- `test_payload_type_enum_has_exactly_five_members`

**Fix:** Remove REVERSE_SHELL from PayloadType enum

### Scenario 2: Network Code in Payload

```python
# bypass_engine.py - WRONG
def _generate_license_check_bypass(self, ...):
    code = b"\x48\x31\xc0"  # XOR RAX, RAX
    code += b"ws2_32.dll"   # ← SCOPE VIOLATION: network library
    return code
```

**Failed Tests:**
- `test_license_bypass_payload_contains_no_socket_operations`
- `test_source_has_no_socket_connection_code`

**Fix:** Remove network library references from payload generation

### Scenario 3: Forbidden Term in Source

```python
# bypass_engine.py - WRONG
def generate_payload(...):
    # Create reverse shell connection  ← SCOPE VIOLATION in comment
    payload = self._generate_license_check_bypass(...)
```

**Failed Tests:**
- `test_source_has_no_reverse_shell_references`

**Fix:** Remove "reverse shell" references from comments and code

## Coverage Validation

### Check Coverage Metrics

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py \
  --cov=intellicrack.core.exploitation.bypass_engine \
  --cov-report=term-missing
```

### Expected Coverage

```
----------- coverage: platform win32, python 3.12.8 -----------
Name                                                    Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------------------
intellicrack\core\exploitation\bypass_engine.py           250      5    98%   156-158
-------------------------------------------------------------------------------------
TOTAL                                                     250      5    98%
```

**Target:** > 95% line coverage, > 90% branch coverage

## Debugging Failed Tests

### Enable Verbose Output

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -vv
```

### Print Payload Content

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -vv -s
```

### Run Single Test with Traceback

```bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py::TestPayloadTypeEnumScopeValidation::test_payload_type_enum_has_no_shell_payloads -vv --tb=long
```

## Continuous Integration

### Pre-Commit Hook

```bash
# .git/hooks/pre-commit
#!/bin/bash
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -x
if [ $? -ne 0 ]; then
    echo "ERROR: BypassEngine scope validation failed. Commit rejected."
    exit 1
fi
```

### CI/CD Pipeline

```yaml
# .github/workflows/scope-validation.yml
name: Scope Validation
on: [push, pull_request]
jobs:
  validate-scope:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run scope validation tests
        run: |
          pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -v
```

## Maintenance

### After Modifying bypass_engine.py

1. Run scope validation tests immediately
2. Verify all 118 tests pass
3. Check coverage metrics
4. Review any new code for scope violations
5. Update tests if new legitimate license bypass features added

### Before Merging PRs

```bash
# Full validation suite
pixi run pytest tests/core/exploitation/test_bypass_engine_scope_validation.py -v --cov=intellicrack.core.exploitation.bypass_engine --cov-report=term-missing

# Verify no regressions in other tests
pixi run pytest tests/core/exploitation/test_bypass_engine_production.py -v
pixi run pytest tests/core/exploitation/test_bypass_engine_comprehensive.py -v
```

## Troubleshooting

### Tests Pass but Coverage Low

**Cause:** New code added without corresponding tests
**Fix:** Add tests for new PayloadType values or generator methods

### Tests Fail After Legitimate Change

**Cause:** Tests need updating for new license bypass feature
**Fix:** Update test expectations for new legitimate functionality

### Source Scanning False Positive

**Cause:** Legitimate term flagged (e.g., "shellcode" for license bypass)
**Fix:** Review context - "shellcode" is legitimate for license bypass assembly

## Summary

**118 comprehensive tests** validate complete scope compliance:

- ✓ NO shell-related payloads
- ✓ NO network exploitation
- ✓ NO malware capabilities
- ✓ ONLY license bypass functionality

**All tests MUST pass before merging code changes.**
