# Crypto Key Extractor Test Coverage

## Overview

Comprehensive production-grade tests for `intellicrack/core/exploitation/crypto_key_extractor.py` (2,852 lines).

**Total Test Coverage:**
- 18 test classes
- 46 test methods
- Tests validate REAL cryptographic key extraction from binaries
- NO mocks or stubs - all tests use actual crypto libraries and real keys

## Test Philosophy

These tests validate **genuine offensive security capabilities** for extracting cryptographic keys from protected software binaries. Every test:

1. Uses real cryptographic keys generated with proper libraries
2. Embeds keys in realistic binary formats
3. Validates extraction actually works (tests FAIL when extraction fails)
4. Checks metadata, confidence scores, and context information
5. Tests edge cases with corrupted, obfuscated, and fragmented data

## Test Categories

### 1. RSA Key Extraction (5 tests)
**Class:** `TestRSAKeyExtraction`

Tests validate extraction of RSA keys in various formats and sizes:

- `test_extract_rsa_2048_der_format`: RSA-2048 in DER/PKCS#8 format
- `test_extract_rsa_4096_pem_format`: RSA-4096 in PEM format
- `test_extract_rsa_crt_components`: Chinese Remainder Theorem components (p, q, dP, dQ, qInv)
- `test_extract_rsa_public_key_only`: Public key extraction when private key unavailable
- `test_extract_multiple_rsa_keys`: Multiple RSA keys of different sizes (1024, 2048, 3072)

**Key Validations:**
- Correct key size detection (2048, 4096 bits)
- Confidence scores > 0.5
- Non-empty key bytes
- CRT component detection in OpenSSL structures

### 2. AES Key Schedule Detection (4 tests)
**Class:** `TestAESKeyExtraction`

Tests validate AES key schedule detection and original key recovery:

- `test_extract_aes_128_key_schedule`: AES-128 expanded key schedule detection
- `test_extract_aes_256_key_schedule`: AES-256 expanded key schedule detection
- `test_detect_aes_sbox_proximity`: S-box proximity indicates nearby keys
- `test_aes_round_constants_detection`: Rcon detection in memory

**Key Validations:**
- Key size detection (128/256 bits)
- Original key recovery from expanded schedule
- S-box pattern matching
- Round constant identification

### 3. ECC Key Extraction (3 tests)
**Class:** `TestECCKeyExtraction`

Tests validate elliptic curve cryptography key extraction:

- `test_extract_p256_private_key`: NIST P-256 curve private key
- `test_extract_p384_private_key`: NIST P-384 curve private key
- `test_detect_ecc_curve_oids`: Curve OIDs (P-256, P-384, P-521, secp256k1)

**Key Validations:**
- Curve size detection (256, 384 bits)
- OID pattern matching
- DER format parsing

### 4. ChaCha20 State Detection (2 tests)
**Class:** `TestChaCha20Extraction`

Tests validate ChaCha20 cipher state detection:

- `test_extract_chacha20_constants`: "expand 32-byte k" constant detection
- `test_chacha20_sigma_constant`: Sigma constant hex pattern matching

**Key Validations:**
- Constant string detection
- Key proximity to constants
- Context identification

### 5. DES/3DES Key Schedules (1 test)
**Class:** `TestDESKeyExtraction`

Tests validate DES key schedule detection:

- `test_extract_3des_key_schedule`: PC1/PC2 permutation pattern detection

**Key Validations:**
- Permutation table detection
- Key schedule proximity

### 6. Memory Pattern Detection (2 tests)
**Class:** `TestMemoryPatternDetection`

Tests validate crypto-specific memory patterns:

- `test_detect_heap_key_structure_headers`: Heap structure headers (0x00000001)
- `test_detect_16byte_aligned_keys`: 16-byte alignment detection

**Key Validations:**
- Structure header recognition
- Alignment-based detection
- Heap allocation patterns

### 7. Crypto API Structure Detection (2 tests)
**Class:** `TestCryptoAPIStructureDetection`

Tests validate detection of crypto library structures:

- `test_detect_openssl_rsa_structure`: OpenSSL RSA_ST structure parsing
- `test_detect_bcrypt_key_magic`: Windows BCrypt magic value (KBCM)

**Key Validations:**
- OpenSSL structure offsets (n, e, d, p, q)
- BCrypt magic value detection
- Platform-specific structures

### 8. Key Format Detection (4 tests)
**Class:** `TestKeyFormatDetection`

Tests validate various key format recognition:

- `test_detect_pem_format_rsa_key`: PEM format with BEGIN/END markers
- `test_detect_pkcs1_header`: PKCS#1 DER header detection
- `test_detect_jwk_format`: JSON Web Key format
- `test_detect_ssh_key_format`: SSH key markers (ssh-rsa, ssh-ed25519)

**Key Validations:**
- Format-specific headers
- PEM metadata extraction
- DER format parsing
- JWK JSON structure
- SSH format markers

### 9. Key Reconstruction From Partial Data (2 tests)
**Class:** `TestKeyReconstructionFromPartialData`

Tests validate reconstruction of complete keys from fragments:

- `test_reconstruct_rsa_from_modulus_and_exponent`: RSA from separated n and e
- `test_recover_aes_key_from_expanded_schedule`: Original AES key from expansion

**Key Validations:**
- Component-based reconstruction
- Schedule inversion algorithms
- Partial data handling

### 10. Entropy-Based Key Detection (2 tests)
**Class:** `TestEntropyBasedKeyDetection`

Tests validate entropy analysis for symmetric keys:

- `test_high_entropy_symmetric_keys_detected`: High-entropy sequences flagged
- `test_low_entropy_data_not_detected_as_keys`: Zero/repeating patterns ignored

**Key Validations:**
- Entropy calculation
- Confidence thresholding
- False positive prevention

### 11. Side-Channel Analysis Patterns (2 tests)
**Class:** `TestSideChannelAnalysisPatterns`

Tests validate side-channel attack pattern detection:

- `test_detect_aes_t_table_cache_timing_patterns`: AES T-table detection
- `test_detect_rsa_square_multiply_timing_patterns`: RSA exponent timing

**Key Validations:**
- Cache timing signatures
- Square-and-multiply patterns
- Side-channel indicators

### 12. Real-World Binary Extraction (2 tests)
**Class:** `TestRealWorldBinaryExtraction`

Tests validate extraction from realistic scenarios:

- `test_extract_from_protected_binary_with_multiple_keys`: Multi-key binaries
- `test_extract_from_binary_with_obfuscated_keys`: Obfuscation resistance

**Key Validations:**
- Multiple key type detection
- Obfuscation handling
- Junk data filtering

### 13. Extracted Key Metadata (3 tests)
**Class:** `TestExtractedKeyMetadata`

Tests validate metadata completeness:

- `test_extracted_key_has_valid_address`: Memory address ranges
- `test_extracted_key_has_confidence_score`: Confidence 0.0-1.0
- `test_extracted_key_has_context_information`: Descriptive context strings

**Key Validations:**
- Address validity
- Confidence range checking
- Non-empty context

### 14. Edge Cases and Error Handling (5 tests)
**Class:** `TestExtractorEdgeCases`

Tests validate robustness:

- `test_extract_from_empty_binary`: Empty input handling
- `test_extract_from_small_binary`: <256 byte binaries
- `test_extract_from_corrupted_key_data`: Corruption resistance
- `test_extract_from_all_zeros`: Zero-data false positive prevention
- `test_extract_from_random_data`: Random data handling

**Key Validations:**
- Graceful error handling
- No crashes on invalid data
- Low false positive rate
- Empty list returns

### 15. Extractor State Persistence (2 tests)
**Class:** `TestExtractorStatePersistence`

Tests validate state management:

- `test_multiple_extractions_accumulate_keys`: State accumulation
- `test_extractor_state_reset_between_instances`: Instance independence

**Key Validations:**
- Key accumulation across calls
- Independent instance state
- No cross-contamination

### 16. Binary File Extraction (2 tests)
**Class:** `TestBinaryFileExtraction`

Tests validate file-based extraction:

- `test_extract_from_binary_file`: File path extraction
- `test_extract_from_nonexistent_file`: Error handling

**Key Validations:**
- File I/O operations
- FileNotFoundError raising
- Path handling

### 17. Key Export (1 test)
**Class:** `TestKeyExport`

Tests validate key export functionality:

- `test_export_keys_creates_files`: Export to output directory

**Key Validations:**
- File creation
- Directory handling
- Export completeness

### 18. Performance (2 tests)
**Class:** `TestPerformance`

Tests validate extraction speed:

- `test_extract_from_large_binary_completes_in_reasonable_time`: 10MB in <30s
- `test_extract_from_medium_binary_is_fast`: 1MB in <5s

**Key Validations:**
- Time limits
- Scalability
- Performance baselines

## Fixtures

### Crypto Key Generation Fixtures
- `rsa_2048_key`: Real RSA-2048 private key (cryptography library)
- `rsa_4096_key`: Real RSA-4096 private key
- `ecc_p256_key`: Real P-256 ECC private key
- `ecc_p384_key`: Real P-384 ECC private key
- `aes_256_key`: Real AES-256 key (random bytes)
- `aes_128_key`: Real AES-128 key
- `chacha20_key`: Real ChaCha20 key

### Helper Functions
- `create_binary_with_embedded_rsa_key()`: Embed RSA keys in DER/PEM/PKCS1 formats
- `create_binary_with_aes_schedule()`: Embed AES expanded key schedules
- `create_binary_with_chacha_state()`: Embed ChaCha20 state with constants
- `create_openssl_rsa_structure()`: Create OpenSSL RSA_ST memory structures

### Extractor Fixture
- `extractor`: Fresh CryptoKeyExtractor instance for each test

### Directory Fixtures
- `test_binary_dir`: Temporary directory for test binaries

## Test Coverage Summary

**Cryptographic Algorithms:**
- ✅ RSA (1024, 2048, 3072, 4096 bit)
- ✅ AES (128, 256 bit) with key schedule
- ✅ ECC (P-256, P-384, secp256k1)
- ✅ ChaCha20
- ✅ 3DES

**Key Formats:**
- ✅ PEM (PKCS#8)
- ✅ DER (PKCS#8, PKCS#1)
- ✅ JWK (JSON Web Key)
- ✅ SSH (ssh-rsa, ssh-ed25519)
- ✅ Raw binary

**Crypto Libraries:**
- ✅ OpenSSL structures (RSA_ST, EC_KEY_ST)
- ✅ Windows BCrypt (magic values, headers)
- ✅ Platform-agnostic formats

**Detection Methods:**
- ✅ Pattern matching (S-box, round constants)
- ✅ Structure parsing (offsets, magic values)
- ✅ Entropy analysis
- ✅ Format headers (PEM, DER, JWK)
- ✅ Memory alignment
- ✅ Side-channel indicators

**Edge Cases:**
- ✅ Empty binaries
- ✅ Small binaries (<256 bytes)
- ✅ Corrupted key data
- ✅ All-zero data
- ✅ Random data
- ✅ Obfuscated keys
- ✅ Multiple keys
- ✅ Partial/fragmented keys

**Performance:**
- ✅ 1MB binaries (<5 seconds)
- ✅ 10MB binaries (<30 seconds)

## Critical Success Criteria

Every test validates REAL functionality:

1. **No Mocks:** All tests use actual cryptographic libraries (cryptography, PyCryptodome)
2. **Real Keys:** Generated with proper key generation functions
3. **Actual Embedding:** Keys embedded in realistic binary formats
4. **Genuine Extraction:** Tests verify extractor finds and parses keys correctly
5. **Failure Detection:** Tests FAIL when extraction doesn't work (not when code runs)

## Running Tests

```bash
# Run all crypto key extractor tests
pytest tests/core/exploitation/test_crypto_key_extractor.py -v

# Run specific test class
pytest tests/core/exploitation/test_crypto_key_extractor.py::TestRSAKeyExtraction -v

# Run specific test
pytest tests/core/exploitation/test_crypto_key_extractor.py::TestRSAKeyExtraction::test_extract_rsa_2048_der_format -v

# Run with coverage
pytest tests/core/exploitation/test_crypto_key_extractor.py --cov=intellicrack.core.exploitation.crypto_key_extractor --cov-report=html
```

## Dependencies

Required for tests to run:
- `cryptography` (RSA, ECC key generation)
- `pycryptodome` (AES, ChaCha20, DES3)
- `pytest` (test framework)
- `pytest-cov` (coverage reporting)

## File Location

**Test File:** `D:\Intellicrack\tests\core\exploitation\test_crypto_key_extractor.py`

**Target Module:** `D:\Intellicrack\intellicrack\core\exploitation\crypto_key_extractor.py`

## Validation Approach

Tests prove extraction works by:

1. **Generating Real Keys:** Using proper crypto libraries
2. **Embedding in Binaries:** Realistic byte layouts
3. **Running Extraction:** Calling extractor methods
4. **Validating Results:** Checking extracted keys match expectations
5. **Verifying Metadata:** Addresses, confidence, context are correct

Tests FAIL when:
- No keys extracted when expected
- Wrong key type detected
- Incorrect key size
- Low confidence scores (<0.5)
- Missing metadata
- Invalid addresses
- Corrupted key data causes crashes

## Type Annotations

All test code includes complete type annotations:
- Function parameters
- Return types
- Fixture types
- Helper function signatures

Example:
```python
def create_binary_with_embedded_rsa_key(
    binary_path: Path, rsa_key: rsa.RSAPrivateKey, format_type: str = "DER"
) -> bytes:
```

## Production Readiness

These tests are production-ready:
- ✅ No placeholders or TODOs
- ✅ Complete implementations
- ✅ Proper error handling
- ✅ Performance benchmarks
- ✅ Edge case coverage
- ✅ Type safety
- ✅ Clear documentation
- ✅ Real-world scenarios

## Future Expansion

Potential additional tests:
- Montgomery reduction constant extraction
- Modular exponentiation window detection
- ECC point operation patterns
- More crypto library structures (mbedTLS, BoringSSL)
- Encrypted key handling
- Hardware security module extraction
- Additional curve support (Curve25519, Edwards25519)
- Power analysis pattern validation
- EM emission signature detection
