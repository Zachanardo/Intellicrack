"""Production tests for patch analyzer.

Validates real patch analysis for vulnerability research, including pattern detection,
severity assessment, and patch comparison capabilities.

Copyright (C) 2025 Zachary Flint
Licensed under GNU General Public License v3.0
"""

import tempfile
from pathlib import Path
from typing import Any

import pytest

from intellicrack.core.vulnerability_research.patch_analyzer import PatchAnalyzer


class TestPatchAnalyzerInitialization:
    """Tests for patch analyzer initialization."""

    def test_initialization(self) -> None:
        analyzer = PatchAnalyzer()

        assert analyzer.patch_patterns is not None
        assert "buffer_overflow" in analyzer.patch_patterns
        assert "format_string" in analyzer.patch_patterns
        assert "integer_overflow" in analyzer.patch_patterns
        assert "use_after_free" in analyzer.patch_patterns
        assert "race_condition" in analyzer.patch_patterns

    def test_pattern_structure(self) -> None:
        analyzer = PatchAnalyzer()

        assert all(isinstance(patterns, list) for patterns in analyzer.patch_patterns.values())
        assert all(isinstance(pattern, str) for patterns in analyzer.patch_patterns.values() for pattern in patterns)


class TestPatchFileAnalysis:
    """Tests for analyzing patch files."""

    def test_analyze_buffer_overflow_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/buffer.c b/src/buffer.c
        index 1234567..abcdefg 100644
        --- a/src/buffer.c
        +++ b/src/buffer.c
        @@ -10,7 +10,7 @@
         void process_input(char *input) {
             char buffer[256];
        -    strcpy(buffer, input);  // Vulnerable to buffer overflow
        +    strncpy(buffer, input, sizeof(buffer) - 1);  // Fixed buffer overflow
        +    buffer[sizeof(buffer) - 1] = '\\0';
             return;
         }
        """

        patch_file = tmp_path / "buffer_overflow.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] > 0
        assert any(v["type"] == "buffer_overflow" for v in result["vulnerabilities"])
        assert result["severity"] in ["low", "medium", "high", "critical"]

    def test_analyze_format_string_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/log.c b/src/log.c
        --- a/src/log.c
        +++ b/src/log.c
        @@ -5,7 +5,7 @@
         void log_message(char *msg) {
        -    printf(msg);  // Format string vulnerability
        +    printf("%s", msg);  // Fixed
         }
        """

        patch_file = tmp_path / "format_string.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert any(v["type"] == "format_string" for v in result["vulnerabilities"])

    def test_analyze_use_after_free_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/memory.c b/src/memory.c
        --- a/src/memory.c
        +++ b/src/memory.c
        @@ -15,8 +15,9 @@
         void cleanup() {
             free(ptr);
        -    use_pointer(ptr);  // Use after free vulnerability
        +    ptr = NULL;
        +    // Removed use of freed memory
         }
        """

        patch_file = tmp_path / "use_after_free.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert any(v["type"] == "use_after_free" for v in result["vulnerabilities"])

    def test_analyze_patch_with_multiple_vulnerabilities(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/vulnerable.c b/src/vulnerable.c
        --- a/src/vulnerable.c
        +++ b/src/vulnerable.c
        @@ -10,10 +10,12 @@
         void process() {
             char buf[128];
        -    strcpy(buf, user_input);  // Buffer overflow
        -    printf(buf);              // Format string
        +    strncpy(buf, user_input, sizeof(buf) - 1);
        +    printf("%s", buf);

        -    int size = get_size();
        -    char *data = malloc(size);  // Integer overflow possible
        +    size_t size = get_size();
        +    if (size > MAX_SIZE) return;
        +    char *data = malloc(size);
         }
        """

        patch_file = tmp_path / "multiple_vulns.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] >= 2
        assert result["severity"] in ["medium", "high", "critical"]

    def test_analyze_nonexistent_file(self) -> None:
        analyzer = PatchAnalyzer()

        result = analyzer.analyze_patch_file("/nonexistent/patch.diff")

        assert result["success"] is False
        assert "error" in result
        assert "not found" in result["error"].lower()

    def test_analyze_empty_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_file = tmp_path / "empty.patch"
        patch_file.write_text("")

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] == 0
        assert result["severity"] == "none"


class TestPatchComparison:
    """Tests for comparing patches."""

    def test_compare_two_patches(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch1_content = """
        diff --git a/src/file.c b/src/file.c
        --- a/src/file.c
        +++ b/src/file.c
        @@ -5,7 +5,7 @@
        -    strcpy(buffer, input);
        +    strncpy(buffer, input, 256);
        """

        patch2_content = """
        diff --git a/src/file.c b/src/file.c
        --- a/src/file.c
        +++ b/src/file.c
        @@ -5,7 +5,8 @@
        -    strcpy(buffer, input);
        +    strncpy(buffer, input, sizeof(buffer) - 1);
        +    buffer[sizeof(buffer) - 1] = '\\0';
        """

        patch1_file = tmp_path / "patch1.diff"
        patch2_file = tmp_path / "patch2.diff"

        patch1_file.write_text(patch1_content)
        patch2_file.write_text(patch2_content)

        result = analyzer.compare_patches(str(patch1_file), str(patch2_file))

        assert result["success"] is True
        assert "patch1" in result
        assert "patch2" in result
        assert "evolution" in result

    def test_compare_identifies_new_vulnerabilities(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch1_content = "Simple patch with strcpy"
        patch2_content = "Patch with strcpy and printf format string vulnerability"

        patch1_file = tmp_path / "old.patch"
        patch2_file = tmp_path / "new.patch"

        patch1_file.write_text(patch1_content)
        patch2_file.write_text(patch2_content)

        result = analyzer.compare_patches(str(patch1_file), str(patch2_file))

        assert result["success"] is True
        evolution = result["evolution"]
        assert "new_vulnerabilities" in evolution
        assert "fixed_vulnerabilities" in evolution
        assert "persistent_vulnerabilities" in evolution

    def test_compare_identifies_fixed_vulnerabilities(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch1_content = "Patch with buffer overflow strcpy and sprintf"
        patch2_content = "Clean patch with no vulnerabilities"

        patch1_file = tmp_path / "vulnerable.patch"
        patch2_file = tmp_path / "fixed.patch"

        patch1_file.write_text(patch1_content)
        patch2_file.write_text(patch2_content)

        result = analyzer.compare_patches(str(patch1_file), str(patch2_file))

        assert result["success"] is True
        assert "fixed_vulnerabilities" in result["evolution"]

    def test_compare_with_missing_file(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_file = tmp_path / "exists.patch"
        patch_file.write_text("test content")

        result = analyzer.compare_patches(str(patch_file), "/nonexistent.patch")

        assert result["success"] is False
        assert "error" in result


class TestSeverityAssessment:
    """Tests for vulnerability severity assessment."""

    def test_critical_severity_assignment(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        Multiple critical issues:
        strcpy buffer overflow
        sprintf format string
        gets dangerous function
        buffer overflow in heap
        stack overflow vulnerability
        dangling pointer use after free
        """

        patch_file = tmp_path / "critical.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["severity"] in ["high", "critical"]
        assert result["severity_score"] >= 6

    def test_high_severity_assignment(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        High severity issues:
        strcpy buffer overflow
        sprintf format string
        race condition TOCTOU
        """

        patch_file = tmp_path / "high.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["severity"] in ["medium", "high", "critical"]

    def test_medium_severity_assignment(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        Medium issues:
        strcpy buffer overflow
        integer overflow
        """

        patch_file = tmp_path / "medium.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["severity"] in ["low", "medium", "high"]

    def test_low_severity_assignment(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        Minor issue:
        strcpy used once
        """

        patch_file = tmp_path / "low.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["severity"] in ["none", "low", "medium"]

    def test_none_severity_for_clean_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/clean.c b/src/clean.c
        --- a/src/clean.c
        +++ b/src/clean.c
        @@ -5,7 +5,7 @@
         void safe_function() {
             // No vulnerabilities here
             return;
         }
        """

        patch_file = tmp_path / "clean.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["severity"] == "none"
        assert result["severity_score"] == 0


class TestVulnerabilityPatterns:
    """Tests for vulnerability pattern detection."""

    def test_buffer_overflow_patterns(self) -> None:
        analyzer = PatchAnalyzer()

        patterns = analyzer.patch_patterns["buffer_overflow"]

        assert any("strcpy" in p for p in patterns)
        assert any("sprintf" in p for p in patterns)
        assert any("gets" in p for p in patterns)

    def test_format_string_patterns(self) -> None:
        analyzer = PatchAnalyzer()

        patterns = analyzer.patch_patterns["format_string"]

        assert any("printf" in p for p in patterns)
        assert any("%n" in p for p in patterns)

    def test_integer_overflow_patterns(self) -> None:
        analyzer = PatchAnalyzer()

        patterns = analyzer.patch_patterns["integer_overflow"]

        assert any("integer" in p and "overflow" in p for p in patterns)

    def test_race_condition_patterns(self) -> None:
        analyzer = PatchAnalyzer()

        patterns = analyzer.patch_patterns["race_condition"]

        assert any("race" in p for p in patterns)
        assert any("TOCTOU" in p for p in patterns)


class TestRealWorldPatches:
    """Tests simulating real-world patch scenarios."""

    def test_security_update_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        Security Update: CVE-2024-XXXX

        Fix buffer overflow vulnerability in input parsing

        diff --git a/src/parser.c b/src/parser.c
        --- a/src/parser.c
        +++ b/src/parser.c
        @@ -100,8 +100,10 @@ int parse_input(char *input) {
             char buffer[1024];
        -    strcpy(buffer, input);
        +    if (strlen(input) >= sizeof(buffer)) {
        +        return -1;
        +    }
        +    strncpy(buffer, input, sizeof(buffer) - 1);
        +    buffer[sizeof(buffer) - 1] = '\\0';
             return process_buffer(buffer);
         }
        """

        patch_file = tmp_path / "security_update.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] > 0
        assert any(v["type"] == "buffer_overflow" for v in result["vulnerabilities"])

    def test_multi_file_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/file1.c b/src/file1.c
        --- a/src/file1.c
        +++ b/src/file1.c
        @@ -10,7 +10,7 @@
        -    strcpy(buf, input);
        +    safe_copy(buf, input);

        diff --git a/src/file2.c b/src/file2.c
        --- a/src/file2.c
        +++ b/src/file2.c
        @@ -20,7 +20,7 @@
        -    printf(user_data);
        +    printf("%s", user_data);
        """

        patch_file = tmp_path / "multi_file.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] >= 1


class TestEdgeCases:
    """Tests for edge cases and error handling."""

    def test_binary_patch_file(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_file = tmp_path / "binary.patch"
        patch_file.write_bytes(b"\x00\x01\x02\x03\x04\x05")

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True

    def test_very_large_patch(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = "strcpy buffer overflow\n" * 10000

        patch_file = tmp_path / "large.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True
        assert result["vulnerability_count"] > 0

    def test_unicode_patch_content(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = """
        diff --git a/src/unicode.c b/src/unicode.c
        --- a/src/unicode.c
        +++ b/src/unicode.c
        @@ -5,7 +5,7 @@
        -    strcpy(buffer, "unicode: 你好世界");
        +    safe_copy(buffer, "unicode: 你好世界");
        """

        patch_file = tmp_path / "unicode.patch"
        patch_file.write_text(patch_content, encoding="utf-8")

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["success"] is True


class TestPatchMetadata:
    """Tests for patch metadata extraction."""

    def test_analysis_includes_timestamp(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_file = tmp_path / "test.patch"
        patch_file.write_text("test content")

        result = analyzer.analyze_patch_file(str(patch_file))

        assert "analysis_timestamp" in result
        assert isinstance(result["analysis_timestamp"], str)

    def test_analysis_includes_patch_file_path(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_file = tmp_path / "metadata.patch"
        patch_file.write_text("test content")

        result = analyzer.analyze_patch_file(str(patch_file))

        assert result["patch_file"] == str(patch_file)

    def test_vulnerability_includes_confidence(self, tmp_path: Path) -> None:
        analyzer = PatchAnalyzer()

        patch_content = "strcpy buffer overflow vulnerability"

        patch_file = tmp_path / "conf.patch"
        patch_file.write_text(patch_content)

        result = analyzer.analyze_patch_file(str(patch_file))

        if result["vulnerability_count"] > 0:
            vuln = result["vulnerabilities"][0]
            assert "confidence" in vuln
            assert 0.0 <= vuln["confidence"] <= 1.0
