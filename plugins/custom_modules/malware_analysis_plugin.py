"""
Malware Analysis Plugin Template
Specialized template for malware analysis and detection
"""

import hashlib
import re
from typing import Dict, List, Set


class MalwareAnalysisPlugin:
    def __init__(self):
        self.name = "Malware Analysis Plugin"
        self.version = "1.0.0"
        self.description = "Template for malware analysis and detection"
        self.ioc_patterns = self._load_ioc_patterns()

    def _load_ioc_patterns(self) -> Dict[str, List[str]]:
        """Load Indicators of Compromise patterns."""
        return {
            'suspicious_apis': [
                'VirtualAlloc', 'VirtualProtect', 'CreateRemoteThread',
                'WriteProcessMemory', 'ReadProcessMemory', 'GetProcAddress',
                'LoadLibrary', 'CreateProcess', 'ShellExecute'
            ],
            'crypto_apis': [
                'CryptAcquireContext', 'CryptCreateHash', 'CryptHashData',
                'CryptDeriveKey', 'CryptEncrypt', 'CryptDecrypt'
            ],
            'network_apis': [
                'InternetOpen', 'InternetConnect', 'HttpOpenRequest',
                'HttpSendRequest', 'URLDownloadToFile', 'WinHttpOpen'
            ]
        }

    def analyze(self, binary_path):
        """Comprehensive malware analysis."""
        results = []
        results.append(f"Malware analysis of: {binary_path}")

        # Calculate file hash
        try:
            with open(binary_path, 'rb') as f:
                file_data = f.read()
                file_hash = hashlib.sha256(file_data).hexdigest()
                results.append(f"SHA256: {file_hash}")
        except Exception as e:
            results.append(f"Hash calculation error: {e}")
            return results

        # Check for suspicious APIs
        suspicious_count = 0
        for category, apis in self.ioc_patterns.items():
            found_apis = []
            for api in apis:
                if api.encode() in file_data:
                    found_apis.append(api)
                    suspicious_count += 1

            if found_apis:
                results.append(f"{category.replace('_', ' ').title()} found:")
                for api in found_apis:
                    results.append(f"  - {api}")

        # Risk assessment
        if suspicious_count > 10:
            results.append("⚠️ HIGH RISK: Many suspicious APIs detected")
        elif suspicious_count > 5:
            results.append("⚠️ MEDIUM RISK: Some suspicious APIs detected")
        else:
            results.append("✅ LOW RISK: Few suspicious indicators")

        # Check for packed/encrypted sections
        entropy = self._calculate_entropy(file_data[:1024])
        if entropy > 7.5:
            results.append("⚠️ High entropy detected - possibly packed/encrypted")

        return results

    def _calculate_entropy(self, data: bytes) -> float:
        """Calculate Shannon entropy."""
        if not data:
            return 0.0

        byte_counts = [0] * 256
        for byte in data:
            byte_counts[byte] += 1

        entropy = 0.0
        data_len = len(data)

        for count in byte_counts:
            if count > 0:
                probability = count / data_len
                entropy -= probability * (probability.bit_length() - 1)

        return entropy

def register():
    return MalwareAnalysisPlugin()
